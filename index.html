<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>阳明侠自然解压 - 直播优化版</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        /* 隐藏所有滚动条 */
        *::-webkit-scrollbar {
            display: none;
        }
        
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overscroll-behavior: none;
            touch-action: none;
            background: #000;
        }
        
        body {
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100vw;
        }
        
        .mobile-live-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            overflow: hidden;
            background: #000;
        }
        
        /* 上部：交易看板 - 调整为50%高度，全宽，无边框 */
        .trading-section {
            height: 50vh;
            position: relative;
            z-index: 10;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.9);
            /* 移除边框 */
            border: none;
            box-shadow: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .trading-board-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px; /* 减少内边距 */
            border: none; /* 移除边框 */
            background: rgba(0, 0, 0, 0.95);
        }
        
        /* 嵌入的交易看板样式调整 - 全宽度无边框 */
        .embedded-board {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            overflow: hidden;
            box-shadow: none; /* 移除阴影 */
        }
        
        /* 可拖动的阳明侠头像 - 缩小以节省空间 */
        .draggable-avatar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 9999;
            cursor: move;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            user-select: none;
            background: transparent !important;
            border: none !important;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5));
            touch-action: none;
        }
        
        .draggable-avatar.dragging {
            cursor: grabbing;
            opacity: 0.9;
        }
        
        .avatar-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            overflow: hidden;
            margin-bottom: 3px;
            border: 2px solid #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        
        .avatar-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .avatar-name {
            font-size: 11px;
            font-weight: bold;
            color: #4ecdc4 !important;
            font-family: 'STKaiti', 'KaiTi', serif;
            text-shadow: 1px 1px 3px #000;
            text-align: center;
            padding: 2px 6px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        /* 中部：自然解压区域 - 调整到45%高度 */
        .nature-section {
            height: 45vh;
            background: rgba(0, 0, 0, 0.98);
            position: relative;
            padding: 0;
            z-index: 8;
            overflow: hidden;
            border: none; /* 移除边框 */
        }
        
        .nature-title {
            position: absolute;
            top: 8px;
            left: 12px;
            z-index: 30;
            font-size: 1em;
            font-weight: bold;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
            padding: 4px 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .nature-info {
            position: absolute;
            top: 8px;
            right: 12px;
            background: rgba(0, 0, 0, 0.7);
            color: #4ecdc4;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.6em;
            z-index: 3;
            display: flex;
            align-items: center;
            gap: 4px;
            border: 1px solid rgba(78, 205, 196, 0.3);
            backdrop-filter: blur(3px);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ecdc4;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        /* 视频容器 - 全尺寸无边框 */
        .video-container {
            width: 100%;
            height: calc(100% - 30px); /* 为控制栏留出空间 */
            position: relative;
            overflow: hidden;
            border: none;
        }
        
        .nature-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.95) contrast(1.1) saturate(1.1);
            transition: filter 0.5s ease;
        }
        
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(5, 5, 15, 0.3) 0%,
                transparent 20%,
                transparent 80%,
                rgba(5, 5, 15, 0.3) 100%
            );
            pointer-events: none;
            z-index: 2;
        }
        
        /* 底部：新闻滚动条 - 5%高度 */
        .news-section {
            height: 5vh;
            background: rgba(0, 0, 0, 0.95);
            overflow: hidden;
            border-top: none; /* 移除上边框 */
            position: relative;
            z-index: 5;
            backdrop-filter: blur(3px);
        }
        
        .news-scroll-container {
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            background: rgba(20, 20, 30, 0.9);
        }
        
        .news-content {
            position: absolute;
            white-space: nowrap;
            animation: scrollNews 25s linear infinite;
        }
        
        .news-item {
            display: inline-block;
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.15), rgba(78, 205, 196, 0.08));
            padding: 2px 10px;
            border-radius: 8px;
            margin-right: 12px;
            border-left: 2px solid #4ecdc4;
        }
        
        .news-title {
            font-size: 0.65em;
            font-weight: 500;
            color: #e0e0e0;
        }
        
        @keyframes scrollNews {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        /* 控制栏 - 更紧凑，放在视频下方 */
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 3;
            opacity: 0.9;
            padding: 5px 0;
            background: rgba(0, 0, 0, 0.7);
            border-top: 1px solid rgba(78, 205, 196, 0.2);
        }
        
        .video-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #4ecdc4;
            color: #4ecdc4;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65em;
            transition: all 0.3s;
            backdrop-filter: blur(3px);
            min-width: 70px;
            justify-content: center;
        }
        
        .video-btn:hover {
            background: rgba(78, 205, 196, 0.3);
            transform: scale(1.05);
        }
        
        /* 调整交易看板容器的尺寸 - 无边框 */
        .trading-board-frame {
            width: 100%;
            height: 100%;
            border: none;
            transform: scale(1);
            transform-origin: top left;
        }
        
        /* 文件上传界面 */
        .file-upload-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 20, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 100;
            padding: 15px;
            backdrop-filter: blur(5px);
            overflow: hidden;
            border: none;
        }
        
        /* 其他样式保持不变，只移除不需要的样式 */
        
        /* 移除所有不必要的边框和阴影 */
        .trading-board-frame,
        .trading-board-container,
        .trading-section,
        .nature-section,
        .video-container {
            box-shadow: none !important;
        }
        
        /* 添加分隔线效果 - 使用渐变而不是边框 */
        .trading-section::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 10%;
            width: 80%;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(78, 205, 196, 0.3) 20%, 
                rgba(78, 205, 196, 0.5) 50%, 
                rgba(78, 205, 196, 0.3) 80%, 
                transparent 100%);
        }
        
        .news-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 10%;
            width: 80%;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(78, 205, 196, 0.2) 20%, 
                rgba(78, 205, 196, 0.3) 50%, 
                rgba(78, 205, 196, 0.2) 80%, 
                transparent 100%);
            z-index: 1;
        }
        
        /* 音乐上传按钮 */
        .music-upload-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            border: none;
            border-radius: 15px;
            color: white;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="mobile-live-container">
        <!-- 上部：交易看板 (50%) -->
        <div class="trading-section">
            <div class="trading-board-container">
                <!-- 嵌入的交易看板 -->
                <iframe 
                    class="trading-board-frame" 
                    id="tradingBoard"
                    srcdoc='
                        <!DOCTYPE html>
                        <html lang="zh-CN">
                        <head>
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
                            <title>智能音乐交易看板</title>
                            <style>
                                * {
                                    margin: 0;
                                    padding: 0;
                                    box-sizing: border-box;
                                    scrollbar-width: none;
                                    -ms-overflow-style: none;
                                }
                                
                                *::-webkit-scrollbar {
                                    display: none;
                                }
                                
                                html, body {
                                    overflow: hidden;
                                    width: 100%;
                                    height: 100%;
                                    overscroll-behavior: none;
                                    touch-action: none;
                                    background: transparent;
                                }
                                
                                body { 
                                    margin: 0; 
                                    padding: 5px; 
                                    background: transparent; 
                                    font-family: Arial, sans-serif; 
                                    width: 100%;
                                    height: 100%;
                                    display: flex;
                                    justify-content: center;
                                    align-items: center;
                                    overflow: hidden;
                                }
                                .container {
                                    width: 100%;
                                    height: 100%;
                                    background: rgba(0, 0, 0, 0.95);
                                    border-radius: 0; /* 移除圆角 */
                                    padding: 8px;
                                    border: none; /* 移除边框 */
                                    box-sizing: border-box;
                                    overflow: hidden;
                                }
                                .indices-section { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 8px; }
                                .index-card { background: rgba(30, 30, 45, 0.9); border-radius: 4px; padding: 6px; border-left: 2px solid #4ecdc4; cursor: pointer; transition: all 0.3s ease; }
                                .index-card.active { background: rgba(78, 205, 196, 0.2); border-left: 3px solid #4ecdc4; box-shadow: 0 0 8px rgba(78, 205, 196, 0.3); }
                                .index-name { color: #ccc; font-size: 10px; margin-bottom: 2px; }
                                .index-price { color: white; font-size: 13px; font-weight: bold; margin: 2px 0; }
                                .index-change { font-size: 9px; font-weight: bold; }
                                .positive { color: #00ff00; } .negative { color: #ff0000; } .neutral { color: #cccccc; }
                                .chart-container { width: 100%; height: 140px; margin-bottom: 8px; background: rgba(20, 20, 35, 0.9); border-radius: 0; overflow: hidden; border: none; }
                                .control-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; height: 70px; }
                                .voting-area, .music-area { background: rgba(40, 40, 60, 0.8); border-radius: 4px; padding: 6px; border: none; }
                                .voting-title, .music-title { color: #ccc; font-size: 10px; text-align: center; margin-bottom: 4px; }
                                .lights-container { display: flex; gap: 8px; justify-content: center; }
                                .light-wrapper { display: flex; flex-direction: column; align-items: center; }
                                .light { width: 28px; height: 28px; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; border: 1px solid #555; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 11px; }
                                .light:hover { transform: scale(1.2); border-color: #4ecdc4; }
                                .green { background-color: #00ff00; } .red { background-color: #ff0000; } .white { background-color: #ffffff; }
                                .green.level-1 { background-color: #00ff00; } .green.level-2 { background-color: #00cc00; } .green.level-3 { background-color: #009900; } .green.level-4 { background-color: #006600; } .green.level-5 { background-color: #004400; }
                                .red.level-1 { background-color: #ff0000; } .red.level-2 { background-color: #cc0000; } .red.level-3 { background-color: #990000; } .red.level-4 { background-color: #660000; } .red.level-5 { background-color: #440000; }
                                .white.level-1 { background-color: #ffffff; } .white.level-2 { background-color: #cccccc; } .white.level-3 { background-color: #999999; } .white.level-4 { background-color: #666666; } .white.level-5 { background-color: #444444; }
                                .vote-count { font-size: 9px; color: #ccc; margin-top: 2px; font-weight: bold; }
                                .music-controls { display: flex; flex-direction: column; align-items: center; gap: 4px; }
                                .music-buttons-container {
                                    display: flex;
                                    gap: 6px;
                                    justify-content: center;
                                    width: 100%;
                                }
                                .music-btn { 
                                    background: linear-gradient(45deg, #4ecdc4, #44a08d); 
                                    border: none; 
                                    border-radius: 12px; 
                                    color: white; 
                                    padding: 5px 10px; 
                                    font-size: 10px; 
                                    cursor: pointer;
                                    flex: 1;
                                    text-align: center;
                                    min-width: 0;
                                }
                                .relax-btn {
                                    background: linear-gradient(45deg, #4CAF50, #45a049);
                                }
                                .music-btn:active {
                                    transform: scale(0.95);
                                }
                                .music-status { font-size: 9px; color: #ccc; text-align: center; }
                                .current-track { font-size: 8px; color: #888; text-align: center; }
                                .volume-control { width: 80%; margin: 2px 0; }
                                .status-indicator { width: 6px; height: 6px; border-radius: 50%; display: inline-block; margin-left: 3px; }
                                .debug-info { position: absolute; top: 3px; right: 3px; font-size: 7px; color: #666; }
                                .price-sync { font-size: 7px; color: #888; text-align: center; margin-top: 1px; }
                                .price-stable { color: #00ff00; }
                                .price-delayed { color: #ffaa00; }
                            </style>
                        </head>
                        <body>
                            <div class="container">
                                <div class="debug-info" id="debugInfo">交易看板运行中</div>
                                
                                <!-- 指数选择区域 -->
                                <div class="indices-section">
                                    <div class="index-card active" onclick="selectIndex(&#39;btc&#39;)">
                                        <div class="index-name">比特币/USDT <span class="status-indicator" id="btcStatus" style="background-color: #ccc;"></span></div>
                                        <div class="index-price" id="btcPrice">--.--</div>
                                        <div class="index-change" id="btcChange">0.00%</div>
                                        <div class="price-sync" id="btcSync">模拟数据</div>
                                    </div>
                                    <div class="index-card" onclick="selectIndex(&#39;sh&#39;)">
                                        <div class="index-name">上证指数 <span class="status-indicator" id="shStatus" style="background-color: #ccc;"></span></div>
                                        <div class="index-price" id="shPrice">--.--</div>
                                        <div class="index-change" id="shChange">0.00%</div>
                                        <div class="price-sync" id="shSync">模拟数据</div>
                                    </div>
                                    <div class="index-card" onclick="selectIndex(&#39;spy&#39;)">
                                        <div class="index-name">SPDR标普500 <span class="status-indicator" id="spyStatus" style="background-color: #ccc;"></span></div>
                                        <div class="index-price" id="spyPrice">--.--</div>
                                        <div class="index-change" id="spyChange">0.00%</div>
                                        <div class="price-sync" id="spySync">模拟数据</div>
                                    </div>
                                </div>
                                
                                <!-- 图表区域 -->
                                <div class="chart-container">
                                    <div id="tradingview_chart"></div>
                                </div>
                                
                                <!-- 控制和音乐区域 -->
                                <div class="control-section">
                                    <div class="voting-area">
                                        <div class="voting-title">观众情绪投票 ↑→↓</div>
                                        <div class="lights-container">
                                            <div class="light-wrapper" title="看涨投票">
                                                <div class="light green level-1" onclick="vote(&#39;green&#39;)">↑</div>
                                                <div class="vote-count" id="greenCount">0</div>
                                            </div>
                                            <div class="light-wrapper" title="中性投票">
                                                <div class="light white level-1" onclick="vote(&#39;white&#39;)">→</div>
                                                <div class="vote-count" id="whiteCount">0</div>
                                            </div>
                                            <div class="light-wrapper" title="看跌投票">
                                                <div class="light red level-1" onclick="vote(&#39;red&#39;)">↓</div>
                                                <div class="vote-count" id="redCount">0</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="music-area">
                                        <div class="music-title">智能背景音乐</div>
                                        <div class="music-controls">
                                            <div class="music-buttons-container">
                                                <button class="music-btn" onclick="toggleMusic()" id="musicToggle">背景音乐</button>
                                                <button class="music-btn relax-btn" onclick="playRelaxMusic()" id="relaxToggle">放松音乐</button>
                                            </div>
                                            <div class="music-status" id="musicStatus">等待用户交互</div>
                                            <div class="current-track" id="currentTrack">-</div>
                                            <input type="range" class="volume-control" min="0" max="100" value="30" oninput="changeVolume(this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- TradingView脚本 -->
                            <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
                            
                            <script>
                                // 本地音乐库 - 存储在localStorage中
                                let musicLibrary = {
                                    happy: [
                                        { 
                                            name: "默认欢快音乐", 
                                            intensity: 1 
                                        }
                                    ],
                                    neutral: [
                                        { 
                                            name: "默认平和音乐", 
                                            intensity: 1 
                                        }
                                    ],
                                    sad: [
                                        { 
                                            name: "默认悲伤音乐", 
                                            intensity: 1 
                                        }
                                    ],
                                    relax: [
                                        { 
                                            name: "默认放松音乐", 
                                            intensity: 1 
                                        }
                                    ]
                                };

                                // 从父页面获取本地音乐文件
                                let localMusicFiles = {
                                    happy: [],
                                    neutral: [],
                                    sad: [],
                                    relax: []
                                };

                                // 模拟市场数据
                                const marketData = {
                                    btc: {
                                        symbol: "BINANCE:BTCUSDT",
                                        name: "比特币/USDT",
                                        tvSymbol: "BINANCE:BTCUSDT",
                                        currentPrice: 89462,
                                        previousPrice: 89463,
                                        changePercent: -0.01,
                                        interval: "5"
                                    },
                                    sh: {
                                        symbol: "SSE:000001",
                                        name: "上证指数",
                                        tvSymbol: "SSE:000001", 
                                        currentPrice: 3858,
                                        previousPrice: 3850,
                                        changePercent: 0.21,
                                        interval: "1D"
                                    },
                                    spy: {
                                        symbol: "AMEX:SPY",
                                        name: "SPDR标普500",
                                        tvSymbol: "AMEX:SPY",
                                        currentPrice: 663.00,
                                        previousPrice: 660.00,
                                        changePercent: 0.45,
                                        interval: "5"
                                    }
                                };

                                // 初始化变量
                                let votes = {
                                    green: 0,
                                    white: 0,
                                    red: 0
                                };
                                
                                let musicEnabled = false;
                                let currentAudio = null;
                                let currentIndex = "btc";
                                let globalVolume = 0.3;
                                let audioInitialized = false;
                                let currentMood = "neutral";
                                let playingRelaxMusic = false;
                                let tradingViewWidget = null;
                                let currentTrackIndex = {
                                    happy: 0,
                                    neutral: 0,
                                    sad: 0,
                                    relax: 0
                                };

                                // 模拟价格变化
                                let priceSimulatorInterval = null;

                                // 调试信息
                                function debug(message) {
                                    console.log("DEBUG:", message);
                                    document.getElementById("debugInfo").textContent = message;
                                }

                                // 页面加载完成后执行
                                window.addEventListener("load", function() {
                                    debug("交易看板加载完成");
                                    loadVotes();
                                    initTradingView();
                                    updateDisplay();
                                    
                                    // 使用模拟数据初始化价格
                                    initializePrices();
                                    
                                    // 启动模拟价格变化
                                    startPriceSimulation();
                                    
                                    // 从父页面加载本地音乐
                                    loadLocalMusicFromParent();
                                    
                                    // 全局点击激活音频
                                    document.addEventListener("click", function() {
                                        if (!audioInitialized) {
                                            audioInitialized = true;
                                            debug("音频已激活");
                                            document.getElementById("musicStatus").textContent = "音频就绪，可以播放音乐";
                                        }
                                    });
                                });

                                // 从父页面加载本地音乐
                                function loadLocalMusicFromParent() {
                                    // 向父页面请求本地音乐
                                    try {
                                        window.parent.postMessage({ action: "getLocalMusic" }, "*");
                                    } catch(e) {
                                        debug("无法访问父页面，可能处于隔离环境");
                                    }
                                }

                                // 监听父页面的消息
                                window.addEventListener("message", function(event) {
                                    if (event.data && event.data.action === "updateLocalMusic") {
                                        localMusicFiles = event.data.musicFiles || localMusicFiles;
                                        debug(`收到本地音乐文件：${Object.values(localMusicFiles).reduce((sum, arr) => sum + arr.length, 0)} 首`);
                                        updateMusicStatus();
                                    }
                                });

                                // 更新音乐状态显示
                                function updateMusicStatus() {
                                    const totalSongs = Object.values(localMusicFiles).reduce((sum, arr) => sum + arr.length, 0);
                                    if (totalSongs > 0) {
                                        document.getElementById("musicStatus").textContent = `已加载 ${totalSongs} 首本地音乐`;
                                    } else {
                                        document.getElementById("musicStatus").textContent = "无本地音乐，使用默认音乐";
                                    }
                                }

                                // 初始化价格显示
                                function initializePrices() {
                                    Object.keys(marketData).forEach(index => {
                                        const data = marketData[index];
                                        updateIndexData(index, data.currentPrice, data.changePercent, "模拟数据");
                                    });
                                    debug("价格初始化完成（模拟数据）");
                                }

                                // 启动模拟价格变化
                                function startPriceSimulation() {
                                    if (priceSimulatorInterval) {
                                        clearInterval(priceSimulatorInterval);
                                    }
                                    
                                    // 每10秒模拟一次价格变化
                                    priceSimulatorInterval = setInterval(() => {
                                        simulatePriceChange();
                                    }, 10000);
                                    
                                    debug("模拟价格变化已启动");
                                }

                                // 模拟价格变化
                                function simulatePriceChange() {
                                    Object.keys(marketData).forEach(index => {
                                        const data = marketData[index];
                                        
                                        // 生成随机小幅度变化 (-0.2% 到 +0.2%)
                                        const randomChange = (Math.random() - 0.5) * 0.4;
                                        const newPrice = data.currentPrice * (1 + randomChange/100);
                                        const newChangePercent = data.changePercent + randomChange;
                                        
                                        // 更新数据
                                        data.previousPrice = data.currentPrice;
                                        data.currentPrice = parseFloat(newPrice.toFixed(2));
                                        data.changePercent = parseFloat(newChangePercent.toFixed(2));
                                        
                                        // 更新显示
                                        const now = new Date().toLocaleTimeString();
                                        updateIndexData(index, data.currentPrice, data.changePercent, `模拟数据 · ${now}`);
                                    });
                                    
                                    if (musicEnabled && !playingRelaxMusic) {
                                        updateMusicBasedOnVotes();
                                    }
                                }

                                // 更新指数显示
                                function updateIndexData(index, price, changePercent, source = "模拟数据") {
                                    const priceElement = document.getElementById(`${index}Price`);
                                    const changeElement = document.getElementById(`${index}Change`);
                                    const statusElement = document.getElementById(`${index}Status`);
                                    const syncElement = document.getElementById(`${index}Sync`);
                                    
                                    if (priceElement) {
                                        if (index === "btc") {
                                            priceElement.textContent = Math.round(price).toLocaleString("en-US");
                                        } else {
                                            priceElement.textContent = price.toFixed(2);
                                        }
                                        
                                        priceElement.style.transition = "all 0.5s ease";
                                        priceElement.style.color = changePercent > 0 ? "#00ff00" : changePercent < 0 ? "#ff0000" : "#ffffff";
                                    }
                                    
                                    if (changeElement) {
                                        changeElement.textContent = `${changePercent >= 0 ? "+" : ""}${changePercent.toFixed(2)}%`;
                                        changeElement.className = `index-change ${changePercent > 0 ? "positive" : changePercent < 0 ? "negative" : "neutral"}`;
                                        changeElement.style.transition = "all 0.5s ease";
                                    }
                                    
                                    if (statusElement) {
                                        statusElement.style.backgroundColor = changePercent > 0 ? "#00ff00" : changePercent < 0 ? "#ff0000" : "#cccccc";
                                        statusElement.style.transition = "background-color 0.5s ease";
                                    }
                                    
                                    if (syncElement) {
                                        syncElement.textContent = source;
                                        syncElement.className = `price-sync price-stable`;
                                    }
                                    
                                    if (index === currentIndex) {
                                        debug(`${marketData[index].name}: ${price.toFixed(2)} (${changePercent >= 0 ? "+" : ""}${changePercent.toFixed(2)}%)`);
                                    }
                                }

                                // 加载投票数据
                                function loadVotes() {
                                    try {
                                        const saved = localStorage.getItem("tradingVotes");
                                        if (saved) {
                                            votes = JSON.parse(saved);
                                            // 更新显示
                                            updateDisplay();
                                        }
                                    } catch (e) {
                                        debug("加载投票数据失败");
                                    }
                                }

                                // 保存投票数据
                                function saveVotes() {
                                    try {
                                        localStorage.setItem("tradingVotes", JSON.stringify(votes));
                                    } catch (e) {
                                        debug("保存投票数据失败");
                                    }
                                }

                                // 投票功能
                                function vote(color) {
                                    votes[color] = (votes[color] || 0) + 1;
                                    saveVotes();
                                    updateDisplay();
                                    
                                    // 点击效果
                                    const light = document.querySelector(`.light.${color}`);
                                    light.style.transform = "scale(1.3)";
                                    light.style.boxShadow = "0 0 15px gold";
                                    setTimeout(() => {
                                        light.style.transform = "scale(1)";
                                        light.style.boxShadow = "none";
                                    }, 300);
                                    
                                    debug(`投票成功: ${color}票数: ${votes[color]}`);
                                    
                                    // 如果背景音乐已启用，根据投票自动调整音乐
                                    if (musicEnabled && !playingRelaxMusic) {
                                        updateMusicBasedOnVotes();
                                        debug(`投票触发音乐更新: ${color}`);
                                    }
                                }

                                // 更新显示
                                function updateDisplay() {
                                    ["green", "white", "red"].forEach(color => {
                                        const count = votes[color] || 0;
                                        document.getElementById(`${color}Count`).textContent = count;
                                        const light = document.querySelector(`.light.${color}`);
                                        if (light) {
                                            const level = Math.min(Math.floor(count / 2) + 1, 5);
                                            light.className = `light ${color} level-${level}`;
                                        }
                                    });
                                }

                                // 选择指数
                                function selectIndex(index) {
                                    currentIndex = index;
                                    document.querySelectorAll(".index-card").forEach(card => card.classList.remove("active"));
                                    event.currentTarget.classList.add("active");
                                    updateDisplay();
                                    
                                    // 切换K线图
                                    switchChart(index);
                                    debug(`切换到指数: ${marketData[index].name}`);
                                }

                                // 切换K线图
                                function switchChart(index) {
                                    const symbol = marketData[index].tvSymbol;
                                    const interval = marketData[index].interval;
                                    
                                    if (tradingViewWidget) {
                                        document.getElementById("tradingview_chart").innerHTML = "";
                                        initTradingViewWithSymbol(symbol, interval);
                                    }
                                }

                                // 使用指定符号初始化TradingView
                                function initTradingViewWithSymbol(symbol, interval) {
                                    if (typeof TradingView === "undefined") {
                                        debug("TradingView库加载中...");
                                        setTimeout(() => initTradingViewWithSymbol(symbol, interval), 500);
                                        return;
                                    }
                                    
                                    tradingViewWidget = new TradingView.widget({
                                        "width": "100%",
                                        "height": "140",
                                        "symbol": symbol,
                                        "interval": interval,
                                        "timezone": "Asia/Shanghai",
                                        "theme": "dark",
                                        "style": "1",
                                        "locale": "zh_CN",
                                        "enable_publishing": false,
                                        "hide_top_toolbar": true,
                                        "hide_legend": true,
                                        "hide_side_toolbar": false,
                                        "container_id": "tradingview_chart"
                                    });
                                    
                                    debug(`K线图切换到: ${symbol} (${interval})`);
                                }

                                // TradingView图表初始化
                                function initTradingView() {
                                    if (typeof TradingView === "undefined") {
                                        debug("TradingView库加载中...");
                                        setTimeout(initTradingView, 500);
                                        return;
                                    }
                                    
                                    const symbol = marketData[currentIndex].tvSymbol;
                                    const interval = marketData[currentIndex].interval;
                                    
                                    tradingViewWidget = new TradingView.widget({
                                        "width": "100%",
                                        "height": "140",
                                        "symbol": symbol,
                                        "interval": interval,
                                        "timezone": "Asia/Shanghai",
                                        "theme": "dark",
                                        "style": "1",
                                        "locale": "zh_CN",
                                        "enable_publishing": false,
                                        "hide_top_toolbar": true,
                                        "hide_legend": true,
                                        "hide_side_toolbar": false,
                                        "container_id": "tradingview_chart"
                                    });
                                    
                                    debug(`K线图初始化: ${marketData[currentIndex].name}`);
                                }

                                // 播放指定类型的音乐
                                function playMusic(mood) {
                                    debug(`播放 ${mood} 音乐`);
                                    
                                    if (!musicEnabled && mood !== "relax") {
                                        debug("背景音乐未启用");
                                        return;
                                    }

                                    // 停止当前音乐
                                    if (currentAudio) {
                                        currentAudio.pause();
                                        currentAudio = null;
                                    }

                                    // 优先使用本地音乐文件
                                    const localTracks = localMusicFiles[mood] || [];
                                    const availableTracks = localTracks.length > 0 ? localTracks : musicLibrary[mood] || [];
                                    
                                    // 确保有音乐可选
                                    if (!availableTracks || availableTracks.length === 0) {
                                        debug(`没有找到 ${mood} 类型的音乐`);
                                        document.getElementById("musicStatus").textContent = `没有${mood}类型的音乐`;
                                        return;
                                    }
                                    
                                    // 获取当前曲目索引
                                    let trackIndex = currentTrackIndex[mood] || 0;
                                    if (trackIndex >= availableTracks.length) {
                                        trackIndex = 0;
                                        currentTrackIndex[mood] = 0;
                                    }
                                    
                                    const selectedTrack = availableTracks[trackIndex];

                                    debug(`播放音乐: ${selectedTrack.name}`);
                                    document.getElementById("musicStatus").textContent = "播放音乐中...";

                                    try {
                                        if (localTracks.length > 0 && selectedTrack.objectUrl) {
                                            // 播放本地音乐文件
                                            currentAudio = new Audio(selectedTrack.objectUrl);
                                        } else {
                                            // 如果没有本地音乐，尝试在线音乐（作为后备）
                                            const fallbackUrls = {
                                                happy: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
                                                neutral: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3",
                                                sad: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3",
                                                relax: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-7.mp3"
                                            };
                                            currentAudio = new Audio(fallbackUrls[mood] || fallbackUrls.neutral);
                                        }
                                        
                                        currentAudio.loop = false; // 不循环，播完换下一首
                                        currentAudio.volume = globalVolume;
                                        
                                        currentAudio.addEventListener("canplaythrough", function() {
                                            debug("音乐可以播放");
                                            
                                            const playPromise = currentAudio.play();
                                            if (playPromise !== undefined) {
                                                playPromise.then(() => {
                                                    debug("音乐播放成功");
                                                    const moodText = mood === "happy" ? "🎉 欢快" : 
                                                                   mood === "sad" ? "😢 悲伤" : 
                                                                   mood === "relax" ? "🌿 放松" : "😐 平和";
                                                    document.getElementById("musicStatus").textContent = `${moodText} 音乐播放中`;
                                                    document.getElementById("currentTrack").textContent = `${selectedTrack.name}`;
                                                }).catch(error => {
                                                    debug("播放被阻止: " + error.message);
                                                    document.getElementById("musicStatus").textContent = "播放被阻止，请点击页面激活音频";
                                                });
                                            }
                                        });
                                        
                                        currentAudio.addEventListener("error", function(e) {
                                            debug("音乐播放错误: " + (currentAudio.error ? currentAudio.error.message : "未知错误"));
                                            document.getElementById("musicStatus").textContent = "播放失败，尝试下一首";
                                            
                                            // 尝试下一首
                                            retryWithNextTrack(mood, trackIndex);
                                        });
                                        
                                        currentAudio.addEventListener("ended", function() {
                                            debug("当前音乐播放结束");
                                            currentTrackIndex[mood] = (trackIndex + 1) % availableTracks.length;
                                            
                                            // 延迟后播放下一首
                                            setTimeout(() => {
                                                if ((musicEnabled && !playingRelaxMusic) || (playingRelaxMusic && mood === "relax")) {
                                                    playMusic(mood);
                                                }
                                            }, 500);
                                        });

                                    } catch (error) {
                                        debug("播放异常: " + error.message);
                                        document.getElementById("musicStatus").textContent = "播放失败";
                                    }
                                }

                                // 重试播放下一首
                                function retryWithNextTrack(mood, currentIndex) {
                                    const localTracks = localMusicFiles[mood] || [];
                                    const availableTracks = localTracks.length > 0 ? localTracks : musicLibrary[mood] || [];
                                    if (availableTracks.length === 0) return;
                                    
                                    currentTrackIndex[mood] = (currentIndex + 1) % availableTracks.length;
                                    
                                    // 延迟后重试
                                    setTimeout(() => {
                                        if ((musicEnabled && !playingRelaxMusic) || (playingRelaxMusic && mood === "relax")) {
                                            playMusic(mood);
                                        }
                                    }, 1000);
                                }

                                // 播放放松音乐
                                function playRelaxMusic() {
                                    if (!audioInitialized) {
                                        debug("请先点击页面任意位置激活音频");
                                        return;
                                    }
                                    
                                    // 如果已经在播放放松音乐，则停止
                                    if (playingRelaxMusic) {
                                        if (currentAudio) {
                                            currentAudio.pause();
                                            currentAudio = null;
                                        }
                                        playingRelaxMusic = false;
                                        document.getElementById("relaxToggle").textContent = "放松音乐";
                                        document.getElementById("relaxToggle").style.background = "linear-gradient(45deg, #4CAF50, #45a049)";
                                        document.getElementById("musicStatus").textContent = "放松音乐已停止";
                                        document.getElementById("currentTrack").textContent = "-";
                                        debug("放松音乐已停止");
                                        return;
                                    }
                                    
                                    // 播放放松音乐
                                    playingRelaxMusic = true;
                                    const relaxBtn = document.getElementById("relaxToggle");
                                    relaxBtn.textContent = "⏹️ 停止放松";
                                    relaxBtn.style.background = "linear-gradient(45deg, #ff6b6b, #ee5a24)";
                                    
                                    // 如果背景音乐正在播放，先停止
                                    if (musicEnabled) {
                                        musicEnabled = false;
                                        document.getElementById("musicToggle").textContent = "背景音乐";
                                        document.getElementById("musicToggle").style.background = "linear-gradient(45deg, #667eea, #764ba2)";
                                    }
                                    
                                    debug("开始播放放松音乐");
                                    playMusic("relax");
                                }

                                // 切换背景音乐开关
                                function toggleMusic() {
                                    if (!audioInitialized) {
                                        debug("请先点击页面任意位置激活音频");
                                        return;
                                    }

                                    // 如果正在播放放松音乐，先停止
                                    if (playingRelaxMusic) {
                                        if (currentAudio) {
                                            currentAudio.pause();
                                            currentAudio = null;
                                        }
                                        playingRelaxMusic = false;
                                        document.getElementById("relaxToggle").textContent = "放松音乐";
                                        document.getElementById("relaxToggle").style.background = "linear-gradient(45deg, #4CAF50, #45a049)";
                                    }

                                    musicEnabled = !musicEnabled;
                                    const toggleBtn = document.getElementById("musicToggle");
                                    
                                    if (musicEnabled) {
                                        toggleBtn.textContent = "⏹️ 停止背景";
                                        toggleBtn.style.background = "linear-gradient(45deg, #ff6b6b, #ee5a24)";
                                        debug("背景音乐已启用");
                                        // 根据当前投票自动选择音乐类型
                                        updateMusicBasedOnVotes();
                                    } else {
                                        toggleBtn.textContent = "背景音乐";
                                        toggleBtn.style.background = "linear-gradient(45deg, #667eea, #764ba2)";
                                        if (currentAudio) {
                                            currentAudio.pause();
                                            currentAudio = null;
                                        }
                                        document.getElementById("musicStatus").textContent = "背景音乐已停止";
                                        document.getElementById("currentTrack").textContent = "-";
                                        debug("背景音乐已停止");
                                    }
                                }

                                // 根据投票调整音乐
                                function updateMusicBasedOnVotes() {
                                    if (!musicEnabled || playingRelaxMusic) return;
                                    
                                    let mood = "neutral";
                                    
                                    debug(`投票统计: 看涨=${votes.green}, 看跌=${votes.red}, 中性=${votes.white}`);
                                    
                                    // 判断主要情绪
                                    if (votes.green > votes.red && votes.green > votes.white) {
                                        mood = "happy"; // 看涨票最多
                                    } else if (votes.red > votes.green && votes.red > votes.white) {
                                        mood = "sad"; // 看跌票最多
                                    } else {
                                        mood = "neutral"; // 平票或中性票最多
                                    }
                                    
                                    debug(`投票分析结果: ${mood}`);
                                    
                                    if (mood !== currentMood) {
                                        currentMood = mood;
                                        playMusic(mood);
                                    } else if (!currentAudio || currentAudio.paused) {
                                        // 如果音乐停止但应该播放，重新播放
                                        playMusic(mood);
                                    }
                                }

                                // 调整音量
                                function changeVolume(value) {
                                    globalVolume = value / 100;
                                    if (currentAudio) {
                                        currentAudio.volume = globalVolume;
                                    }
                                    debug(`音量调整: ${value}%`);
                                }
                            </script>
                        </body>
                        </html>
                    '>
                </iframe>
                
                <!-- 可拖动的阳明侠头像 -->
                <div class="draggable-avatar" id="draggableAvatar">
                    <div class="avatar-circle">
                        <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop&crop=face&fp-x=0.5&fp-y=0.5&fp-z=1&facepad=3" alt="阳明侠">
                    </div>
                    <div class="avatar-name">阳明侠</div>
                </div>
            </div>
        </div>
        
        <!-- 中部：自然解压区域 (45%) -->
        <div class="nature-section">
            <!-- 阳明侠自然解压标题 -->
            <div class="nature-title">阳明侠自然解压</div>
            
            <!-- 信息显示 -->
            <div class="nature-info">
                <div class="status-indicator"></div>
                <span id="videoStatus">请选择本地视频文件</span>
            </div>
            
            <!-- 文件上传界面 -->
            <div class="file-upload-container" id="fileUploadContainer">
                <h2 class="upload-title">📁 选择本地视频文件</h2>
                <p class="upload-instructions">
                    请选择您的本地自然风景视频文件（支持MP4、WebM、OGG格式）
                    <br>视频将被存储在浏览器本地存储中，不会上传到服务器
                </p>
                
                <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">点击选择视频文件</div>
                    <div style="color: #888; font-size: 0.7em;">或拖放文件到这里</div>
                </div>
                
                <input type="file" id="fileInput" class="upload-input" accept="video/*" multiple>
                
                <div class="file-list" id="fileList"></div>
                
                <button class="start-btn" id="startBtn" onclick="startVideoPlayback()" disabled>
                    开始播放
                </button>
                
                <div style="margin-top: 15px; color: #666; font-size: 0.7em;">
                    提示：支持拖放多个视频文件，将按顺序循环播放
                </div>
            </div>
            
            <!-- 视频播放容器 -->
            <div class="video-container" id="videoContainer" style="display: none;">
                <!-- 视频播放区域 -->
                <video class="nature-video" id="natureVideo" 
                       autoplay loop muted playsinline controls>
                    您的浏览器不支持视频播放
                </video>
                <div class="video-overlay"></div>
                
                <!-- 控制栏 -->
                <div class="video-controls">
                    <button class="video-btn" onclick="toggleVideoPlay()" id="playPauseBtn">
                        <span id="playIcon">⏸️</span> 暂停/播放
                    </button>
                    <button class="video-btn" onclick="nextVideo()">
                        🔄 下一个
                    </button>
                    <button class="video-btn" onclick="toggleVideoLibrary()">
                        📁 视频库
                    </button>
                    <button class="video-btn" onclick="addMoreVideos()">
                        ➕ 添加
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 底部：新闻滚动条 (5%) -->
        <div class="news-section">
            <div class="news-scroll-container">
                <div class="news-content" id="newsContent">
                    <!-- 新闻内容由JavaScript动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 视频库 -->
        <div class="video-library" id="videoLibrary">
            <div class="library-title">
                视频库
                <button class="library-close" onclick="toggleVideoLibrary()">×</button>
            </div>
            <div id="libraryList"></div>
        </div>
        
        <!-- 快捷操作提示 -->
        <div class="shortcut-hint" id="shortcutHint">
            🔑 空格键: 播放/暂停 | → 键: 下一个视频 | ← 键: 上一个视频
        </div>
    </div>

    <script>
        // ============================================
        // 配置
        // ============================================
        const CONFIG = {
            adminMode: true,
            maxFileSize: 100 * 1024 * 1024, // 100MB 最大文件大小
            supportedVideoFormats: ['mp4', 'webm', 'ogg', 'mov', 'avi']
        };

        // ============================================
        // 本地音乐管理器
        // ============================================
        class LocalMusicManager {
            constructor() {
                this.musicFiles = {
                    happy: [],
                    neutral: [],
                    sad: [],
                    relax: []
                };
                
                this.objectUrls = []; // 存储ObjectURLs
                
                this.init();
            }
            
            init() {
                this.loadMusicFromStorage();
            }
            
            // 从本地存储加载音乐
            loadMusicFromStorage() {
                try {
                    const saved = localStorage.getItem('localMusicFiles');
                    if (saved) {
                        // 注意：不能直接存储File对象，只存储基本信息
                        const musicInfo = JSON.parse(saved);
                        console.log('找到保存的音乐信息:', musicInfo);
                        // 在实际使用时，需要用户重新选择音乐文件
                    }
                } catch (error) {
                    console.error('加载音乐信息失败:', error);
                }
            }
            
            // 保存音乐信息到本地存储
            saveMusicToStorage() {
                try {
                    // 只保存基本信息，不保存File对象
                    const musicInfo = {};
                    Object.keys(this.musicFiles).forEach(category => {
                        musicInfo[category] = this.musicFiles[category].map(track => ({
                            name: track.name,
                            size: track.size,
                            type: track.type,
                            lastModified: track.lastModified
                        }));
                    });
                    
                    localStorage.setItem('localMusicFiles', JSON.stringify(musicInfo));
                    console.log('音乐信息已保存');
                } catch (error) {
                    console.error('保存音乐信息失败:', error);
                }
            }
            
            // 添加音乐文件到指定分类
            addMusicToCategory(category, files) {
                const validFiles = [];
                
                for (let file of files) {
                    // 检查文件类型
                    const extension = file.name.split('.').pop().toLowerCase();
                    const audioFormats = ['mp3', 'wav', 'ogg', 'm4a', 'flac', 'aac'];
                    
                    if (!audioFormats.includes(extension)) {
                        alert(`音乐文件 "${file.name}" 格式不支持，支持格式: ${audioFormats.join(', ')}`);
                        continue;
                    }
                    
                    // 创建ObjectURL
                    const objectUrl = URL.createObjectURL(file);
                    this.objectUrls.push(objectUrl);
                    
                    const musicObj = {
                        name: file.name,
                        size: this.formatFileSize(file.size),
                        type: file.type,
                        lastModified: new Date(file.lastModified).toLocaleDateString(),
                        objectUrl: objectUrl
                    };
                    
                    validFiles.push(musicObj);
                }
                
                if (validFiles.length > 0) {
                    this.musicFiles[category].push(...validFiles);
                    this.saveMusicToStorage();
                    this.sendMusicToIframe();
                    console.log(`已添加 ${validFiles.length} 首音乐到 ${category} 分类`);
                    return true;
                }
                return false;
            }
            
            // 发送音乐到iframe
            sendMusicToIframe() {
                const iframe = document.getElementById('tradingBoard');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({ 
                        action: 'updateLocalMusic', 
                        musicFiles: this.musicFiles 
                    }, '*');
                }
            }
            
            // 清理ObjectURLs
            cleanupUrls() {
                this.objectUrls.forEach(url => {
                    URL.revokeObjectURL(url);
                });
                this.objectUrls = [];
            }
            
            // 格式化文件大小
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // ============================================
        // 本地视频管理器
        // ============================================
        class LocalVideoManager {
            constructor() {
                this.videoElement = document.getElementById('natureVideo');
                this.videoStatus = document.getElementById('videoStatus');
                this.videoContainer = document.getElementById('videoContainer');
                this.uploadContainer = document.getElementById('fileUploadContainer');
                this.startBtn = document.getElementById('startBtn');
                this.fileInput = document.getElementById('fileInput');
                this.fileList = document.getElementById('fileList');
                this.libraryList = document.getElementById('libraryList');
                this.newsContent = document.getElementById('newsContent');
                
                this.videos = []; // 存储的视频对象
                this.currentVideoIndex = 0;
                this.isPlaying = true;
                this.videoUrls = []; // 存储的ObjectURLs
                
                this.init();
            }
            
            init() {
                this.loadSavedVideos();
                this.initFileUpload();
                this.initDragAndDrop();
                this.initKeyboardShortcuts();
                this.initNewsScroll();
                
                // 如果已有保存的视频，直接进入播放模式
                if (this.videos.length > 0) {
                    this.showVideoPlayer();
                    this.playVideo(0);
                }
            }
            
            // 初始化新闻滚动
            initNewsScroll() {
                const newsData = [
                    { title: '🚀 比特币价格波动，市场情绪多样化', source: '行情分析', time: '实时' },
                    { title: '💎 智能交易看板已集成，支持投票和本地音乐播放', source: '技术动态', time: '刚刚' },
                    { title: '🏦 全球金融市场持续调整中', source: '市场观察', time: '5分钟前' },
                    { title: '📊 交易看板支持本地音乐上传和播放', source: '功能说明', time: '今天' },
                    { title: '🌿 自然解压视频区域占比45%，视觉体验升级', source: '直播优化', time: '今天' },
                    { title: '🎵 音乐播放：右键页面选择"上传本地音乐"添加音乐文件', source: '使用提示', time: '现在' }
                ];
                
                const newsItemsHTML = newsData.map(news => `
                    <div class="news-item">
                        <div class="news-title">${news.title}</div>
                    </div>
                `).join('');
                this.newsContent.innerHTML = newsItemsHTML + newsItemsHTML;
            }
            
            // 初始化文件上传
            initFileUpload() {
                this.fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });
            }
            
            // 初始化拖放功能
            initDragAndDrop() {
                const uploadBox = document.querySelector('.upload-box');
                
                uploadBox.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadBox.style.background = 'rgba(78, 205, 196, 0.15)';
                    uploadBox.style.borderColor = '#3dbcb4';
                });
                
                uploadBox.addEventListener('dragleave', () => {
                    uploadBox.style.background = 'rgba(78, 205, 196, 0.05)';
                    uploadBox.style.borderColor = '#4ecdc4';
                });
                
                uploadBox.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadBox.style.background = 'rgba(78, 205, 196, 0.05)';
                    uploadBox.style.borderColor = '#4ecdc4';
                    
                    if (e.dataTransfer.files.length > 0) {
                        this.handleFiles(e.dataTransfer.files);
                    }
                });
            }
            
            // 处理选择的文件
            handleFiles(files) {
                const validFiles = [];
                
                for (let file of files) {
                    // 检查文件大小
                    if (file.size > CONFIG.maxFileSize) {
                        alert(`文件 "${file.name}" 超过100MB限制，已跳过`);
                        continue;
                    }
                    
                    // 检查文件类型
                    const extension = file.name.split('.').pop().toLowerCase();
                    if (!CONFIG.supportedVideoFormats.includes(extension)) {
                        alert(`文件 "${file.name}" 格式不支持，支持格式: ${CONFIG.supportedVideoFormats.join(', ')}`);
                        continue;
                    }
                    
                    validFiles.push(file);
                }
                
                if (validFiles.length > 0) {
                    this.addVideos(validFiles);
                }
            }
            
            // 添加视频到列表
            addVideos(files) {
                for (let file of files) {
                    // 检查是否已存在相同名称的视频
                    const exists = this.videos.some(v => v.name === file.name);
                    if (exists) {
                        console.log(`视频 "${file.name}" 已存在，已跳过`);
                        continue;
                    }
                    
                    const videoObj = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: this.formatFileSize(file.size),
                        file: file,
                        type: file.type,
                        lastModified: new Date(file.lastModified).toLocaleDateString()
                    };
                    
                    this.videos.push(videoObj);
                }
                
                this.updateFileList();
                this.startBtn.disabled = this.videos.length === 0;
            }
            
            // 更新文件列表显示
            updateFileList() {
                this.fileList.innerHTML = '';
                
                if (this.videos.length === 0) {
                    this.fileList.innerHTML = '<div style="color: #888; text-align: center;">暂无视频文件</div>';
                    return;
                }
                
                this.videos.forEach((video, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div>
                            <div class="file-name">${video.name}</div>
                            <div class="file-size">${video.size} • ${video.type}</div>
                        </div>
                        <button onclick="removeVideo(${index})" style="
                            background: rgba(255, 0, 0, 0.2);
                            border: none;
                            color: #ff6b6b;
                            padding: 4px 8px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 0.7em;
                        ">移除</button>
                    `;
                    this.fileList.appendChild(fileItem);
                });
            }
            
            // 更新视频库显示
            updateLibraryList() {
                this.libraryList.innerHTML = '';
                
                if (this.videos.length === 0) {
                    this.libraryList.innerHTML = '<div style="color: #888; text-align: center;">暂无视频</div>';
                    return;
                }
                
                this.videos.forEach((video, index) => {
                    const libraryItem = document.createElement('div');
                    libraryItem.className = `library-item ${index === this.currentVideoIndex ? 'active' : ''}`;
                    libraryItem.innerHTML = `
                        <div>
                            <div style="color: #fff; font-size: 0.85em;">${video.name}</div>
                            <div style="color: #aaa; font-size: 0.75em;">${video.size}</div>
                        </div>
                    `;
                    libraryItem.onclick = () => this.playVideo(index);
                    this.libraryList.appendChild(libraryItem);
                });
            }
            
            // 开始播放视频
            startVideoPlayback() {
                if (this.videos.length === 0) {
                    alert('请先选择视频文件');
                    return;
                }
                
                this.showVideoPlayer();
                this.saveVideosToStorage();
                this.playVideo(0);
            }
            
            // 显示视频播放器
            showVideoPlayer() {
                this.uploadContainer.style.display = 'none';
                this.videoContainer.style.display = 'block';
                // 显示OBS优化提示
                const obsTip = document.createElement('div');
                obsTip.style.position = 'fixed';
                obsTip.style.top = '10px';
                obsTip.style.right = '10px';
                obsTip.style.background = 'rgba(0, 0, 0, 0.8)';
                obsTip.style.color = '#4ecdc4';
                obsTip.style.padding = '5px 10px';
                obsTip.style.borderRadius = '5px';
                obsTip.style.fontSize = '10px';
                obsTip.style.zIndex = '10000';
                obsTip.style.backdropFilter = 'blur(3px)';
                obsTip.textContent = '📱 OBS手机竖屏布局已优化';
                obsTip.id = 'obsTip';
                document.body.appendChild(obsTip);
                
                setTimeout(() => {
                    const tip = document.getElementById('obsTip');
                    if (tip) document.body.removeChild(tip);
                }, 3000);
            }
            
            // 显示上传界面
            showUploadInterface() {
                this.uploadContainer.style.display = 'flex';
                this.videoContainer.style.display = 'none';
            }
            
            // 播放指定索引的视频
            playVideo(index) {
                if (index < 0 || index >= this.videos.length) return;
                
                // 清理之前的ObjectURL
                this.cleanupUrls();
                
                this.currentVideoIndex = index;
                const video = this.videos[index];
                
                // 创建ObjectURL
                const videoUrl = URL.createObjectURL(video.file);
                this.videoUrls.push(videoUrl);
                
                // 设置视频源
                this.videoElement.src = videoUrl;
                this.videoElement.load();
                
                // 更新状态
                this.videoStatus.textContent = `${video.name} • 播放中`;
                this.updateLibraryList();
                
                // 开始播放
                this.videoElement.play().catch(e => {
                    console.warn('自动播放被阻止:', e);
                    this.isPlaying = false;
                    this.updatePlayButton();
                });
                
                this.isPlaying = true;
                this.updatePlayButton();
                
                // 监听视频结束事件
                this.videoElement.onended = () => {
                    this.nextVideo();
                };
                
                console.log(`正在播放: ${video.name}`);
            }
            
            // 切换到下一个视频
            nextVideo() {
                const nextIndex = (this.currentVideoIndex + 1) % this.videos.length;
                this.playVideo(nextIndex);
            }
            
            // 切换到上一个视频
            prevVideo() {
                const prevIndex = this.currentVideoIndex === 0 ? 
                    this.videos.length - 1 : this.currentVideoIndex - 1;
                this.playVideo(prevIndex);
            }
            
            // 切换播放/暂停
            togglePlay() {
                if (this.isPlaying) {
                    this.videoElement.pause();
                    this.isPlaying = false;
                    this.videoStatus.textContent = '已暂停';
                } else {
                    this.videoElement.play();
                    this.isPlaying = true;
                    this.videoStatus.textContent = '播放中';
                }
                this.updatePlayButton();
            }
            
            // 更新播放按钮
            updatePlayButton() {
                const playIcon = document.getElementById('playIcon');
                if (playIcon) {
                    playIcon.textContent = this.isPlaying ? '⏸️' : '▶️';
                }
            }
            
            // 清理ObjectURLs
            cleanupUrls() {
                this.videoUrls.forEach(url => {
                    URL.revokeObjectURL(url);
                });
                this.videoUrls = [];
            }
            
            // 保存视频到本地存储
            saveVideosToStorage() {
                try {
                    const videoInfo = this.videos.map(v => ({
                        id: v.id,
                        name: v.name,
                        size: v.size,
                        type: v.type,
                        lastModified: v.lastModified
                    }));
                    
                    localStorage.setItem('localVideosInfo', JSON.stringify(videoInfo));
                    console.log('视频信息已保存到本地存储');
                } catch (error) {
                    console.error('保存视频信息失败:', error);
                }
            }
            
            // 从本地存储加载视频信息
            loadSavedVideos() {
                try {
                    const saved = localStorage.getItem('localVideosInfo');
                    if (saved) {
                        const videoInfo = JSON.parse(saved);
                        console.log('找到保存的视频信息:', videoInfo.length, '个视频');
                    }
                } catch (error) {
                    console.error('加载保存的视频信息失败:', error);
                }
            }
            
            // 格式化文件大小
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // 初始化键盘快捷键
            initKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    switch(e.key) {
                        case ' ':
                            e.preventDefault();
                            this.togglePlay();
                            this.showShortcutHint('空格键: 播放/暂停');
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            this.nextVideo();
                            this.showShortcutHint('→ 键: 下一个视频');
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.prevVideo();
                            this.showShortcutHint('← 键: 上一个视频');
                            break;
                        case 'Escape':
                            if (document.getElementById('videoLibrary').classList.contains('visible')) {
                                this.toggleVideoLibrary();
                            }
                            break;
                        case 'l':
                        case 'L':
                            e.preventDefault();
                            this.toggleVideoLibrary();
                            break;
                    }
                });
            }
            
            // 显示快捷操作提示
            showShortcutHint(text) {
                const hintDiv = document.getElementById('shortcutHint');
                if (hintDiv) {
                    hintDiv.textContent = '🔑 ' + text;
                    hintDiv.style.display = 'block';
                    setTimeout(() => {
                        hintDiv.style.display = 'none';
                    }, 1500);
                }
            }
            
            // 切换视频库显示
            toggleVideoLibrary() {
                const library = document.getElementById('videoLibrary');
                library.classList.toggle('visible');
                if (library.classList.contains('visible')) {
                    this.updateLibraryList();
                }
            }
        }

        // ============================================
        // 可拖拽头像管理器
        // ============================================
        class DraggableAvatarManager {
            constructor() {
                this.avatar = document.getElementById('draggableAvatar');
                this.isDragging = false;
                this.currentX = 15;
                this.currentY = 15;
                this.dragEnabled = CONFIG.adminMode;
                
                this.loadPosition();
                this.initDragging();
            }
            
            initDragging() {
                if (!this.dragEnabled) return;
                
                this.avatar.addEventListener('mousedown', (e) => {
                    if (e.shiftKey || this.dragEnabled) {
                        this.startDragging(e);
                    }
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (this.isDragging) {
                        this.drag(e);
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    if (this.isDragging) {
                        this.stopDragging();
                    }
                });
                
                // 触摸屏支持
                this.avatar.addEventListener('touchstart', (e) => {
                    if (this.dragEnabled) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        this.startDragging(touch);
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (this.isDragging) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        this.drag(touch);
                    }
                });
                
                document.addEventListener('touchend', () => {
                    if (this.isDragging) {
                        this.stopDragging();
                    }
                });
            }
            
            startDragging(e) {
                this.isDragging = true;
                this.avatar.classList.add('dragging');
                
                const rect = this.avatar.getBoundingClientRect();
                this.offsetX = (e.clientX || e.pageX) - rect.left;
                this.offsetY = (e.clientY || e.pageY) - rect.top;
                
                this.showShortcutHint();
            }
            
            drag(e) {
                if (!this.isDragging) return;
                
                const tradingSection = document.querySelector('.trading-section');
                const tradingRect = tradingSection.getBoundingClientRect();
                
                let newX = (e.clientX || e.pageX) - this.offsetX - tradingRect.left;
                let newY = (e.clientY || e.pageY) - this.offsetY - tradingRect.top;
                
                newX = Math.max(5, Math.min(newX, tradingRect.width - this.avatar.offsetWidth - 5));
                newY = Math.max(5, Math.min(newY, tradingRect.height - this.avatar.offsetHeight - 5));
                
                this.currentX = newX;
                this.currentY = newY;
                this.avatar.style.left = newX + 'px';
                this.avatar.style.top = newY + 'px';
            }
            
            stopDragging() {
                this.isDragging = false;
                this.avatar.classList.remove('dragging');
                this.savePosition();
                this.hideShortcutHint();
            }
            
            savePosition() {
                if (this.dragEnabled) {
                    const position = { x: this.currentX, y: this.currentY };
                    localStorage.setItem('yangmingAvatarPosition', JSON.stringify(position));
                }
            }
            
            loadPosition() {
                try {
                    const saved = localStorage.getItem('yangmingAvatarPosition');
                    if (saved) {
                        const position = JSON.parse(saved);
                        this.currentX = position.x || 15;
                        this.currentY = position.y || 15;
                        this.avatar.style.left = this.currentX + 'px';
                        this.avatar.style.top = this.currentY + 'px';
                    }
                } catch (error) {
                    console.log('使用默认位置');
                }
            }
            
            showShortcutHint() {
                const hintDiv = document.getElementById('shortcutHint');
                if (hintDiv) {
                    hintDiv.textContent = '📌 拖动头像调整位置';
                    hintDiv.style.display = 'block';
                    setTimeout(() => {
                        if (!this.isDragging) {
                            hintDiv.style.display = 'none';
                        }
                    }, 2000);
                }
            }
            
            hideShortcutHint() {
                const hintDiv = document.getElementById('shortcutHint');
                if (hintDiv) {
                    setTimeout(() => {
                        hintDiv.style.display = 'none';
                    }, 500);
                }
            }
        }

        // ============================================
        // 全局变量和函数
        // ============================================

        let videoManager;
        let avatarManager;
        let musicManager;

        // 交易看板通信函数
        function selectIndex(index) {
            const iframe = document.getElementById('tradingBoard');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ action: 'selectIndex', index: index }, '*');
            }
        }

        function vote(color) {
            const iframe = document.getElementById('tradingBoard');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ action: 'vote', color: color }, '*');
            }
        }

        function toggleMusic() {
            const iframe = document.getElementById('tradingBoard');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ action: 'toggleMusic' }, '*');
            }
        }

        function playRelaxMusic() {
            const iframe = document.getElementById('tradingBoard');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ action: 'playRelaxMusic' }, '*');
            }
        }

        function changeVolume(value) {
            const iframe = document.getElementById('tradingBoard');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ action: 'changeVolume', value: value }, '*');
            }
        }

        // 添加本地音乐文件的函数
        function addLocalMusic(category) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'audio/*';
            input.multiple = true;
            
            input.onchange = (e) => {
                if (e.target.files.length > 0 && musicManager) {
                    const success = musicManager.addMusicToCategory(category, e.target.files);
                    if (success) {
                        alert(`已添加 ${e.target.files.length} 首音乐到 ${getCategoryName(category)}`);
                    }
                }
            };
            
            input.click();
        }

        function getCategoryName(category) {
            const names = {
                happy: '欢快音乐',
                neutral: '平和音乐',
                sad: '悲伤音乐',
                relax: '放松音乐'
            };
            return names[category] || category;
        }

        // 监听来自交易看板的消息
        window.addEventListener('message', function(event) {
            console.log('收到消息:', event.data);
            
            if (event.data && event.data.action === 'getLocalMusic') {
                // 发送本地音乐文件到iframe
                const iframe = document.getElementById('tradingBoard');
                if (iframe && iframe.contentWindow && musicManager) {
                    iframe.contentWindow.postMessage({ 
                        action: 'updateLocalMusic', 
                        musicFiles: musicManager.musicFiles 
                    }, '*');
                }
            }
        });

        // 全局控制函数
        function toggleVideoPlay() {
            if (videoManager) {
                videoManager.togglePlay();
            }
        }

        function nextVideo() {
            if (videoManager) {
                videoManager.nextVideo();
            }
        }

        function prevVideo() {
            if (videoManager) {
                videoManager.prevVideo();
            }
        }

        function toggleVideoLibrary() {
            if (videoManager) {
                videoManager.toggleVideoLibrary();
            }
        }

        function addMoreVideos() {
            // 显示文件选择对话框
            document.getElementById('fileInput').click();
        }

        function startVideoPlayback() {
            if (videoManager) {
                videoManager.startVideoPlayback();
            }
        }

        function removeVideo(index) {
            if (videoManager && videoManager.videos) {
                videoManager.videos.splice(index, 1);
                videoManager.updateFileList();
                videoManager.startBtn.disabled = videoManager.videos.length === 0;
            }
        }

        // 添加上传本地音乐的上下文菜单
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            
            const menu = document.createElement('div');
            menu.style.position = 'fixed';
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            menu.style.background = 'rgba(0, 0, 0, 0.9)';
            menu.style.border = '1px solid #4ecdc4';
            menu.style.borderRadius = '5px';
            menu.style.padding = '10px';
            menu.style.zIndex = '10000';
            menu.style.boxShadow = '0 5px 15px rgba(0,0,0,0.5)';
            
            menu.innerHTML = `
                <div style="color: #4ecdc4; font-size: 12px; margin-bottom: 5px;">上传本地音乐</div>
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <button onclick="addLocalMusic('happy')" style="background: rgba(78, 205, 196, 0.1); border: 1px solid #4ecdc4; color: #4ecdc4; padding: 5px; border-radius: 3px; cursor: pointer; font-size: 11px;">🎉 欢快音乐</button>
                    <button onclick="addLocalMusic('neutral')" style="background: rgba(78, 205, 196, 0.1); border: 1px solid #4ecdc4; color: #4ecdc4; padding: 5px; border-radius: 3px; cursor: pointer; font-size: 11px;">😐 平和音乐</button>
                    <button onclick="addLocalMusic('sad')" style="background: rgba(78, 205, 196, 0.1); border: 1px solid #4ecdc4; color: #4ecdc4; padding: 5px; border-radius: 3px; cursor: pointer; font-size: 11px;">😢 悲伤音乐</button>
                    <button onclick="addLocalMusic('relax')" style="background: rgba(78, 205, 196, 0.1); border: 1px solid #4ecdc4; color: #4ecdc4; padding: 5px; border-radius: 3px; cursor: pointer; font-size: 11px;">🌿 放松音乐</button>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // 点击其他地方关闭菜单
            setTimeout(() => {
                const closeMenu = () => {
                    document.body.removeChild(menu);
                    document.removeEventListener('click', closeMenu);
                };
                document.addEventListener('click', closeMenu);
            }, 100);
        });

        // 页面初始化
        function init() {
            try {
                // 防止默认滚动行为
                document.addEventListener('touchmove', function(e) {
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                // 初始化管理器
                videoManager = new LocalVideoManager();
                avatarManager = new DraggableAvatarManager();
                musicManager = new LocalMusicManager();
                
                console.log('✅ OBS手机竖屏版已初始化');
                console.log('📱 已移除所有滚动条和边框，实现满屏一体显示');
                console.log('🎵 音乐播放支持本地文件（右键页面添加上传）');
                console.log('📊 布局比例：交易看板50% + 视频区45% + 新闻区5%');
                console.log('🗳️ 投票功能正常，音乐播放功能正常');
                console.log('📈 K线图切换功能正常，点击指数按钮可切换');
                console.log('🔑 键盘快捷键：空格键(播放/暂停)、方向键(切换视频)');
                console.log('🎶 使用方法：右键页面选择"上传本地音乐"添加音乐文件');
                
            } catch (error) {
                console.error('初始化失败:', error);
                alert('页面初始化失败，请刷新重试');
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
        
        // 页面卸载时清理资源
        window.addEventListener('beforeunload', () => {
            if (videoManager) {
                videoManager.cleanupUrls();
            }
            if (musicManager) {
                musicManager.cleanupUrls();
            }
        });
        
        // 防止iOS橡皮筋效果
        document.body.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
